# product.py
# terminal command: streamlit run product.py 

import os
import streamlit as st
from langchain_community.chat_models import ChatOpenAI
from langchain.schema import HumanMessage, SystemMessage

# í™˜ê²½ ë³€ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
openai_api_key = os.getenv("OPENAI_API_KEY")

# LangChain ChatOpenAI ì„¤ì •
chat_model = ChatOpenAI(model="gpt-3.5-turbo", temperature=0.7, openai_api_key=openai_api_key)

# Streamlit UI

st.title("ë”¥ëŸ¬ë‹ ê¸°ë°˜ ë‡Œì¢…ì–‘ ì§„ë‹¨ ë³´ê³ ì„œ")

# ì‚¬ìš©ì ì…ë ¥ê°’
st.header("MRI ë°ì´í„° ì…ë ¥")
distance = st.number_input("**ì¢…ì–‘ ì¤‘ì‹¬ê³¼ ë‡Œ ì¤‘ì‹¬ ê°„ ê±°ë¦¬ (í”½ì…€)**", min_value=0.0, format="%.2f")
size = st.number_input("**ì¢…ì–‘ í¬ê¸° (í”½ì…€ ìˆ˜)**", min_value=0, step=1)
irregularity = st.number_input("**ì¢…ì–‘ ë¶ˆê·œì¹™ì„± (ê¼­ì§“ì  ìˆ˜)**", min_value=0, step=1)
risk_score = st.number_input("**ìœ„í—˜ë„ ì ìˆ˜**", min_value=0.0, format="%.2f")

# ë²„íŠ¼ í´ë¦­ ì‹œ LLM í˜¸ì¶œ
if st.button("ê²°ê³¼ ë¶„ì„"):
    with st.spinner("LLM ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
        # LangChain ë©”ì‹œì§€ êµ¬ì„±
        system_message = SystemMessage(
            content=(
                "ë‹¹ì‹ ì€ ë‡Œì¢…ì–‘ ë¶„ì„ì„ ì „ë¬¸ìœ¼ë¡œ í•˜ëŠ” ì˜ë£Œ ë³´ì¡°ì›ì…ë‹ˆë‹¤. "
                "MRI ë°ì´í„°ì—ì„œ ì¶”ì¶œí•œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í™˜ìì—ê²Œ ì¢…ì–‘ì˜ ìœ„ì¹˜, í¬ê¸°, ë¶ˆê·œì¹™ì„±, "
                "ê·¸ë¦¬ê³  ê³„ì‚°ëœ ìœ„í—˜ë„ ì ìˆ˜ì— ëŒ€í•œ ìƒì„¸í•œ í•´ì„ì„ ì œê³µí•©ë‹ˆë‹¤. "
                "ë˜í•œ, í™˜ìì˜ ìƒí™©ì— ì í•©í•œ ë‹¤ìŒ ë‹¨ê³„ì˜ ê¶Œê³  ì‚¬í•­ì„ ì œì•ˆí•´ì•¼ í•©ë‹ˆë‹¤."
            )
        )

        user_message = HumanMessage(
            content=(
                f"ë‹¤ìŒ MRI ë°ì´í„°ì— ê¸°ë°˜í•˜ì—¬ ë‡Œì¢…ì–‘ì— ëŒ€í•œ ì˜í•™ì  í•´ì„ì„ ì‘ì„±í•´ì£¼ì„¸ìš”:\n\n"
                f"- ì¢…ì–‘ ì¤‘ì‹¬ê³¼ ë‡Œ ì¤‘ì‹¬ ê°„ ê±°ë¦¬: {distance:.2f} í”½ì…€\n"
                f"- ì¢…ì–‘ í¬ê¸°: {size} í”½ì…€\n"
                f"- ì¢…ì–‘ ë¶ˆê·œì¹™ì„±(ê¼­ì§“ì  ê°œìˆ˜): {irregularity}\n"
                f"- ìœ„í—˜ë„ ì ìˆ˜: {risk_score:.2f}\n\n"
                "ì•„ë˜ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ê° ì„¹ì…˜ì€ ë°˜ë“œì‹œ '###'ë¡œ êµ¬ë¶„ë˜ì–´ì•¼ í•˜ë©°, "
                "ë‚´ìš©ì€ í™˜ì ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í•˜ê³  ì˜í•™ì  ê¶Œê³  ì‚¬í•­ì€ í•„ìš”ì— ë”°ë¼ ì—¬ëŸ¬ í•­ëª©ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë„˜ë²„ë§í•˜ì„¸ìš”:\n\n"
                "###\n"
                "1. ì¢…ì–‘ ì¤‘ì‹¬ê³¼ ë‡Œ ì¤‘ì‹¬ ê°„ ê±°ë¦¬:\n"
                "   - í‰ê·  ê±°ë¦¬ ê°’ì€ ì•½ 20.74 í”½ì…€ì´ë©°, ìµœì†Œ 4.08 í”½ì…€ì—ì„œ ìµœëŒ€ 58.55 í”½ì…€ë¡œ ê´€ì°°ë©ë‹ˆë‹¤.\n"
                "   - ì¢…ì–‘ ì¤‘ì‹¬ì´ ë‡Œ ì¤‘ì‹¬ê³¼ì˜ ê±°ë¦¬ê°€ **{distance:.2f} í”½ì…€**ì¸ ê²½ìš°:\n"
                "       - ì´ ê°’ì´ í‰ê· (20.74 í”½ì…€)ë³´ë‹¤ **ë†’ë‹¤ë©´**, ë‡Œ ì¤‘ì‹¬ìœ¼ë¡œë¶€í„° **ìƒëŒ€ì ìœ¼ë¡œ ë©€ë¦¬ ìœ„ì¹˜**í•´ ìˆëŠ” ê²ƒìœ¼ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
                "       - íŠ¹íˆ, Q3 (23.31 í”½ì…€)ë¥¼ ì´ˆê³¼í•˜ëŠ” ê²½ìš° ë‡Œ ì¤‘ì‹¬ì—ì„œ **ë” ë¨¼ ìœ„ì¹˜**ë¡œ í‰ê°€ë©ë‹ˆë‹¤.\n"
                "       - ìµœëŒ“ê°’(58.55 í”½ì…€)ì— ê·¼ì ‘í•˜ë©´ ë‡Œì˜ ì™¸ê³½ì— ìœ„ì¹˜í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.\n"
                "   - ë°˜ëŒ€ë¡œ, ê±°ë¦¬ê°€ **Q1 ì´í•˜(15.79 í”½ì…€)**ë¼ë©´ ì¢…ì–‘ì´ ë‡Œì˜ ì¤‘ì‹¬ë¶€ì— ê°€ê¹Œì›Œ ì¤‘ìš”í•œ ë‡Œ ì˜ì—­ì„ ì¹¨ë²”í•  ìœ„í—˜ì´ ë†’ìŠµë‹ˆë‹¤.\n\n"
                "   - í‰ê·  ê±°ë¦¬ ê°’ì€ ì•½ 20.74 í”½ì…€ì´ë©°, ìµœì†Œ 4.08 í”½ì…€ì—ì„œ ìµœëŒ€ 58.55 í”½ì…€ë¡œ ê´€ì°°ë©ë‹ˆë‹¤.\n"
                "   - ì¢…ì–‘ ì¤‘ì‹¬ì´ ë‡Œ ì¤‘ì‹¬ê³¼ì˜ ê±°ë¦¬ê°€ **{distance:.2f} í”½ì…€**ì¸ ê²½ìš°, í•´ë‹¹ ê°’ì´ í‰ê· ê³¼ ê°€ê¹Œìš°ë©´ ì¼ë°˜ì ì¸ ìœ„ì¹˜ë¥¼ ë³´ì…ë‹ˆë‹¤.\n"
                "   - ê±°ë¦¬ê°€ **{distance:.2f} í”½ì…€**ë¡œ 1ì‚¬ë¶„ìœ„ (15.79) ì´í•˜ë¡œ ë‚®ë‹¤ë©´ ë‡Œì˜ ì¤‘ì‹¬ë¶€ì— ê°€ê¹Œì›Œ ì¤‘ìš”í•œ ë‡Œ ì˜ì—­ì„ ì¹¨ë²”í•  ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.\n\n"
                "2. ì¢…ì–‘ í¬ê¸°:\n"
                "   - í‰ê·  í¬ê¸°ëŠ” **455.9 í”½ì…€**ì´ë©°, ìµœì†Œ 1 í”½ì…€ì—ì„œ ìµœëŒ€ 1524 í”½ì…€ê¹Œì§€ ë‹¤ì–‘í•©ë‹ˆë‹¤.\n"
                "   - í˜„ì¬ ì¢…ì–‘ í¬ê¸°ê°€ **{size} í”½ì…€**ì¸ ê²½ìš°, ì¼ë°˜ì ì¸ í¬ê¸° (Q1: 161.75 ~ Q3: 670) ë‚´ì— ì†í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.\n"
                "   - ë§Œì•½ ì¢…ì–‘ í¬ê¸°ê°€ Q3 (670) ì´ìƒì´ë©´ ë¹ ë¥¸ ì„±ì¥ì´ ì˜ì‹¬ë˜ë©°, ì•…ì„± ê°€ëŠ¥ì„±ì„ í‰ê°€í•´ì•¼ í•©ë‹ˆë‹¤.\n\n"
                "3. ì¢…ì–‘ ë¶ˆê·œì¹™ì„±:\n"
                "   - í‰ê·  ê¼­ì§“ì  ìˆ˜ëŠ” **9.2ê°œ**ì´ë©°, ìµœì†Œ 1ê°œì—ì„œ ìµœëŒ€ 15ê°œê¹Œì§€ ë¶„í¬í•©ë‹ˆë‹¤.\n"
                "   - ì¢…ì–‘ì˜ ë¶ˆê·œì¹™ì„±ì´ **{irregularity}**ë¡œ í‰ê· ë³´ë‹¤ ë†’ê±°ë‚˜ Q3 (11ê°œ) ì´ìƒì¼ ê²½ìš° ì•…ì„± ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.\n"
                "   - ê²½ê³„ ë¹„ëŒ€ì¹­ì´ ì‹¬í•˜ë©´ ì¢…ì–‘ì˜ ìœ í˜•ì— ëŒ€í•œ ì •ë°€ ì§„ë‹¨ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\n"
                "4. ìœ„í—˜ë„ ì ìˆ˜:\n"
                "   - ìœ„í—˜ë„ ì ìˆ˜ì˜ í‰ê· ì€ **28.97**ì´ë©°, Q3ëŠ” 41.5ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.\n"
                "   - í™˜ìì˜ ìœ„í—˜ë„ ì ìˆ˜ê°€ **{risk_score:.2f}**ì¼ ê²½ìš°, ë‹¤ìŒê³¼ ê°™ì€ ê¸°ì¤€ì— ë”°ë¼ í‰ê°€í•˜ì„¸ìš”:\n"
                "      - **1 ~ 11.2** (Q1 ì´í•˜): ë‚®ì€ ìœ„í—˜ë„\n"
                "      - **11.3 ~ 24.65** (Q2): ì¤‘ê°„ ìœ„í—˜ë„\n"
                "      - **24.66 ~ 41.5** (Q3): ë†’ì€ ìœ„í—˜ë„\n"
                "      - **41.6 ì´ìƒ**: ë§¤ìš° ë†’ì€ ìœ„í—˜ë„ (ì¦‰ê°ì  í‰ê°€ í•„ìš”)\n\n"
                "###\n"
                "ë‹¤ìŒì€ ì¢…ì–‘ì˜ ìƒíƒœë¥¼ ì •í™•íˆ í‰ê°€í•˜ê³  ê´€ë¦¬í•˜ê¸° ìœ„í•œ ê¶Œê³  ì‚¬í•­ì…ë‹ˆë‹¤.\n"
                "   - í˜„ì¬ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í™˜ìì—ê²Œ í•„ìš”í•œ ê¶Œê³  ì‚¬í•­ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ê¶Œê³  ì‚¬í•­ì´ ì—¬ëŸ¬ ê°œì¼ ê²½ìš° "
                "   - ê° í•­ëª©ì„ ë„˜ë²„ë§í•˜ì—¬ ì‘ì„±í•´ì£¼ì„¸ìš”. ì˜ˆë¥¼ ë“¤ë©´:\n"
                "      - 1. **ì •ë°€ ì˜ìƒ ê²€ì‚¬**:\n"
                "      ì¢…ì–‘ì˜ ìœ„ì¹˜ì™€ ì¹¨ìŠµ ìƒíƒœë¥¼ ëª…í™•íˆ í™•ì¸í•˜ê¸° ìœ„í•´ MRI ë˜ëŠ” CT ì¶”ê°€ ê²€ì‚¬ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.\n"
                "      - 2. **ì¢…ì–‘ ì¡°ì§ ê²€ì‚¬ (ìƒê²€)**:\n"
                "      ì¢…ì–‘ì˜ ì–‘ì„± ë˜ëŠ” ì•…ì„± ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ì„¸í¬ ì¡°ì§ ê²€ì‚¬ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.\n"
                "      - 3. **ì „ë¬¸ì˜ ìƒë‹´**:\n"
                "      ì‹ ê²½ì™¸ê³¼ ë° ì¢…ì–‘ ì „ë¬¸ì˜ì™€ í˜‘ë ¥í•˜ì—¬ ìˆ˜ìˆ  ë˜ëŠ” ë°©ì‚¬ì„  ì¹˜ë£Œ ê³„íšì„ ìˆ˜ë¦½í•´ì•¼ í•©ë‹ˆë‹¤.\n\n"
                "###\n"
                "ë‹¤ìŒì€ í™˜ìì˜ ë‡Œì¢…ì–‘ ìƒíƒœì— ëŒ€í•œ ì¢…í•©ì ì¸ ìš”ì•½ì…ë‹ˆë‹¤."
                "   - ì¢…ì–‘ì˜ ì£¼ìš” íŠ¹ì„±, ìœ„í—˜ë„, ìœ„ì¹˜ ë° í•„ìš”í•œ ì¡°ì¹˜ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ì„¤ëª…í•˜ê³ , ë¹ ë¥¸ ì§„ë‹¨ê³¼ ì¹˜ë£Œì˜ í•„ìš”ì„±ì„ ê°•ì¡°í•´ì£¼ì„¸ìš”."
            )
        )

        # LLM í˜¸ì¶œ ë° ì‘ë‹µ ì²˜ë¦¬
        response = chat_model([system_message, user_message])
        response_content = response.content

        # êµ¬ë¶„ì "###"ë¥¼ ê¸°ì¤€ìœ¼ë¡œ íŒŒíŠ¸ ë‚˜ëˆ„ê¸°
        parts = [part.strip() for part in response_content.split("###") if part.strip()]

        # íŒŒíŠ¸ë³„ ë‚´ìš© ì¶œë ¥ (ì¤‘ë³µ ë°©ì§€)
        if len(parts) >= 3:
            # 1. ë¶„ì„ ê²°ê³¼
            st.subheader("ğŸ” ë¶„ì„ ê²°ê³¼")
            st.write(parts[0])  # ì²« ë²ˆì§¸ íŒŒíŠ¸

            st.divider()

            # 2. ì˜í•™ì  ê¶Œê³  ì‚¬í•­
            st.subheader("ğŸ©º ì˜í•™ì  ê¶Œê³  ì‚¬í•­")
            st.write(parts[1])  # ë‘ ë²ˆì§¸ íŒŒíŠ¸

            st.divider()

            # 3. ìµœì¢… ìš”ì•½
            st.subheader("ğŸ‘©â€âš•ï¸ ìµœì¢… ìš”ì•½")
            st.write(parts[2])  # ì„¸ ë²ˆì§¸ íŒŒíŠ¸
        else:
            st.error("LLM ì‘ë‹µì´ ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ ë°˜í™˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì…ë ¥ ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")

